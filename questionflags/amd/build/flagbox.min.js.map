{"version":3,"file":"flagbox.min.js","sources":["../src/flagbox.js"],"sourcesContent":["/**\r\n * Flag box module for local_questionflags.\r\n *\r\n * Handles injecting the reason textarea and saving reasons via AJAX.\r\n *\r\n * @module local_questionflags/flagbox\r\n * @copyright 2024 Question Flags Development Team\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery'], function ($) {\r\n\r\n    /**\r\n     * Submit a reason via AJAX without page reload.\r\n     * @param {number} questionId - The question ID.\r\n     */\r\n    function submitReason(questionId) {\r\n        var reasonBox = document.getElementById('flag-reason-' + questionId);\r\n        if (!reasonBox) {\r\n            return;\r\n        }\r\n\r\n        var formData = new FormData();\r\n        formData.append('save_reason', '1');\r\n        formData.append('questionid', questionId);\r\n        formData.append('reason', reasonBox.value);\r\n        formData.append('sesskey', window.qfSesskey);\r\n\r\n        var status = document.getElementById('reason-status-' + questionId);\r\n        if (status) {\r\n            status.textContent = 'Saving...';\r\n        }\r\n\r\n        fetch(window.location.href, {\r\n            method: 'POST',\r\n            body: formData\r\n        })\r\n            .then(function (response) {\r\n                return response.json();\r\n            })\r\n            .then(function () {\r\n                if (status) {\r\n                    status.textContent = 'Saved';\r\n                    setTimeout(function () {\r\n                        status.textContent = '';\r\n                    }, 2000);\r\n                }\r\n            })\r\n            .catch(function () {\r\n                if (status) {\r\n                    status.textContent = 'Error';\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Initialize the flag box functionality.\r\n     * Injects textareas into flagged questions.\r\n     */\r\n    function init() {\r\n        // Expose submitReason globally for onblur handler\r\n        window.submitReason = submitReason;\r\n\r\n        var questions = document.querySelectorAll('.que');\r\n        questions.forEach(function (question) {\r\n            // Find the content area to inject below question text\r\n            var contentArea = question.querySelector('.content');\r\n            if (!contentArea) {\r\n                return;\r\n            }\r\n\r\n            // Get question ID from the question element\r\n            var questionId = null;\r\n            var idStr = question.id || '';\r\n            if (idStr.indexOf('question-') !== -1) {\r\n                var parts = idStr.split('-');\r\n                var slotNumber = parts[parts.length - 1];\r\n                if (window.questionMapping && window.questionMapping[slotNumber]) {\r\n                    questionId = window.questionMapping[slotNumber];\r\n                }\r\n            }\r\n\r\n            if (!questionId) {\r\n                return;\r\n            }\r\n\r\n            // Check if textarea already exists\r\n            if (document.getElementById('reason-wrapper-' + questionId)) {\r\n                return;\r\n            }\r\n\r\n            // Get current flag state and reason\r\n            var currentFlag = (window.questionFlagsData && window.questionFlagsData[questionId]) || '';\r\n            var reasonText = (window.questionFlagReasons && window.questionFlagReasons[questionId]) || '';\r\n            var isVisible = (currentFlag === 'blue' || currentFlag === 'red');\r\n\r\n            // Create wrapper for the notes section\r\n            var wrapperDiv = document.createElement('div');\r\n            wrapperDiv.id = 'reason-wrapper-' + questionId;\r\n            wrapperDiv.className = 'flag-notes-area';\r\n            wrapperDiv.style.cssText = 'margin-top: 15px; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: ' + (isVisible ? 'block' : 'none') + ';';\r\n\r\n            // Add Label \"My Notes\"\r\n            var label = document.createElement('label');\r\n            label.htmlFor = 'flag-reason-' + questionId;\r\n            label.textContent = 'My Notes';\r\n            label.style.cssText = 'font-weight: bold; display: block; margin-bottom: 5px; color: #333;';\r\n            wrapperDiv.appendChild(label);\r\n\r\n            // Create textarea\r\n            var textarea = document.createElement('textarea');\r\n            textarea.id = 'flag-reason-' + questionId;\r\n            textarea.className = 'form-control';\r\n            textarea.placeholder = 'Add your notes here...';\r\n            textarea.style.cssText = 'width:100%; height:80px; font-size:14px; resize:vertical; margin-bottom: 5px;';\r\n            textarea.value = reasonText;\r\n            textarea.onblur = function () {\r\n                submitReason(questionId);\r\n            };\r\n            wrapperDiv.appendChild(textarea);\r\n\r\n            // Status indicator\r\n            var statusDiv = document.createElement('div');\r\n            statusDiv.id = 'reason-status-' + questionId;\r\n            statusDiv.style.cssText = 'font-size:11px; color:#666; text-align:right; min-height:16px;';\r\n            wrapperDiv.appendChild(statusDiv);\r\n\r\n            // Inject after .qtext if it exists\r\n            var qtext = contentArea.querySelector('.qtext');\r\n            if (qtext && qtext.parentNode === contentArea) {\r\n                if (qtext.nextSibling) {\r\n                    contentArea.insertBefore(wrapperDiv, qtext.nextSibling);\r\n                } else {\r\n                    contentArea.appendChild(wrapperDiv); // Last child, so append is effectively after\r\n                }\r\n            } else {\r\n                // Fallback: append to content area to ensure it's at the end if .qtext is missing/nested\r\n                contentArea.appendChild(wrapperDiv);\r\n            }\r\n        });\r\n\r\n        // Hook into the global submitFlag function to toggle visibility\r\n        // We need to wrap the original function or use an event if possible.\r\n        // Since submitFlag is defined in global scope by PHP, we can wrap it.\r\n        if (typeof window.originalSubmitFlag === 'undefined' && typeof window.submitFlag === 'function') {\r\n            window.originalSubmitFlag = window.submitFlag;\r\n            window.submitFlag = function (questionId, flagColor, currentCmd) {\r\n                // Call original logic\r\n                window.originalSubmitFlag(questionId, flagColor, currentCmd);\r\n\r\n                // Update visibility based on action\r\n                // If currentCmd is 'flag', we are flagging -> show\r\n                // If currentCmd is 'unflag', we are unflagging -> hide\r\n                // Wait small delay for DOM to update or just use logic\r\n\r\n                // Logic based on toggle behavior:\r\n                // If we clicked Blue and it was NOT Blue, we are flagging Blue.\r\n                // If we clicked Blue and it WAS Blue, we are unflagging.\r\n\r\n                var wrapper = document.getElementById('reason-wrapper-' + questionId);\r\n                if (wrapper) {\r\n                    // This logic is tricky because we don't know the exact outcome state synchronously \r\n                    // without duplicating the toggle logic.\r\n                    // However, the original submitFlag updates the UI classes.\r\n                    // Let's polling check the UI state or rely on the fact that if we click, we toggle.\r\n\r\n                    // Simple heuristic: check immediately after execution (sync) or small timeout\r\n                    setTimeout(function () {\r\n                        var btn = document.querySelector('#question-' + questionId + ' .flag-btn.active'); // Assuming active class added? \r\n                        // Actually the PHP inline script reloads or updates UI. \r\n                        // The inline script provided earlier updates classes.\r\n                        // Let's assume we want to show if ANY flag button is active/disabled?\r\n                        // Actually the previous script reloaded the page often unless AJAX.\r\n                        // With AJAX, we need to know the new state.\r\n\r\n                        // Let's look at the implementation of submitFlag in the PHP file.\r\n                        // It does: ... fetch ... then update UI.\r\n\r\n                        // Better approach: Observe DOM changes or listen to custom event if we emitted one.\r\n                        // We did NOT emit a custom JS event in the PHP script.\r\n\r\n                        // Quick fix: The PHP script updates window.questionFlagsData[questionId].\r\n                        // We can check that.\r\n                        var newState = window.questionFlagsData && window.questionFlagsData[questionId];\r\n                        if (newState === 'blue' || newState === 'red') {\r\n                            wrapper.style.display = 'block';\r\n                        } else {\r\n                            wrapper.style.display = 'none';\r\n                        }\r\n                    }, 500); // 500ms delay to allow AJAX to return and update global state\r\n                }\r\n            };\r\n        }\r\n    }\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});\r\n"],"names":["define","$","submitReason","questionId","reasonBox","document","getElementById","formData","FormData","append","value","window","qfSesskey","status","textContent","fetch","location","href","method","body","then","response","json","setTimeout","catch","init","querySelectorAll","forEach","question","contentArea","querySelector","idStr","id","indexOf","parts","split","slotNumber","length","questionMapping","currentFlag","questionFlagsData","reasonText","questionFlagReasons","isVisible","wrapperDiv","createElement","className","style","cssText","label","htmlFor","appendChild","textarea","placeholder","onblur","statusDiv","qtext","parentNode","nextSibling","insertBefore","originalSubmitFlag","submitFlag","flagColor","currentCmd","wrapper","newState","display"],"mappings":";;;;;;;;;AASAA,qCAAO,CAAC,WAAW,SAAUC,YAMhBC,aAAaC,gBACdC,UAAYC,SAASC,eAAe,eAAiBH,eACpDC,eAIDG,SAAW,IAAIC,SACnBD,SAASE,OAAO,cAAe,KAC/BF,SAASE,OAAO,aAAcN,YAC9BI,SAASE,OAAO,SAAUL,UAAUM,OACpCH,SAASE,OAAO,UAAWE,OAAOC,eAE9BC,OAASR,SAASC,eAAe,iBAAmBH,YACpDU,SACAA,OAAOC,YAAc,aAGzBC,MAAMJ,OAAOK,SAASC,KAAM,CACxBC,OAAQ,OACRC,KAAMZ,WAELa,MAAK,SAAUC,iBACLA,SAASC,UAEnBF,MAAK,WACEP,SACAA,OAAOC,YAAc,QACrBS,YAAW,WACPV,OAAOC,YAAc,KACtB,SAGVU,OAAM,WACCX,SACAA,OAAOC,YAAc,mBAiJ9B,CACHW,gBAvIAd,OAAOT,aAAeA,aAENG,SAASqB,iBAAiB,QAChCC,SAAQ,SAAUC,cAEpBC,YAAcD,SAASE,cAAc,eACpCD,iBAKD1B,WAAa,KACb4B,MAAQH,SAASI,IAAM,OACS,IAAhCD,MAAME,QAAQ,aAAqB,KAC/BC,MAAQH,MAAMI,MAAM,KACpBC,WAAaF,MAAMA,MAAMG,OAAS,GAClC1B,OAAO2B,iBAAmB3B,OAAO2B,gBAAgBF,cACjDjC,WAAaQ,OAAO2B,gBAAgBF,gBAIvCjC,aAKDE,SAASC,eAAe,kBAAoBH,iBAK5CoC,YAAe5B,OAAO6B,mBAAqB7B,OAAO6B,kBAAkBrC,aAAgB,GACpFsC,WAAc9B,OAAO+B,qBAAuB/B,OAAO+B,oBAAoBvC,aAAgB,GACvFwC,UAA6B,SAAhBJ,aAA0C,QAAhBA,YAGvCK,WAAavC,SAASwC,cAAc,OACxCD,WAAWZ,GAAK,kBAAoB7B,WACpCyC,WAAWE,UAAY,kBACvBF,WAAWG,MAAMC,QAAU,6IAA+IL,UAAY,QAAU,QAAU,QAGtMM,MAAQ5C,SAASwC,cAAc,SACnCI,MAAMC,QAAU,eAAiB/C,WACjC8C,MAAMnC,YAAc,WACpBmC,MAAMF,MAAMC,QAAU,sEACtBJ,WAAWO,YAAYF,WAGnBG,SAAW/C,SAASwC,cAAc,YACtCO,SAASpB,GAAK,eAAiB7B,WAC/BiD,SAASN,UAAY,eACrBM,SAASC,YAAc,yBACvBD,SAASL,MAAMC,QAAU,gFACzBI,SAAS1C,MAAQ+B,WACjBW,SAASE,OAAS,WACdpD,aAAaC,aAEjByC,WAAWO,YAAYC,cAGnBG,UAAYlD,SAASwC,cAAc,OACvCU,UAAUvB,GAAK,iBAAmB7B,WAClCoD,UAAUR,MAAMC,QAAU,iEAC1BJ,WAAWO,YAAYI,eAGnBC,MAAQ3B,YAAYC,cAAc,UAClC0B,OAASA,MAAMC,aAAe5B,aAC1B2B,MAAME,YACN7B,YAAY8B,aAAaf,WAAYY,MAAME,aAM/C7B,YAAYsB,YAAYP,sBAOS,IAA9BjC,OAAOiD,oBAAmE,mBAAtBjD,OAAOkD,aAClElD,OAAOiD,mBAAqBjD,OAAOkD,WACnClD,OAAOkD,WAAa,SAAU1D,WAAY2D,UAAWC,YAEjDpD,OAAOiD,mBAAmBzD,WAAY2D,UAAWC,gBAW7CC,QAAU3D,SAASC,eAAe,kBAAoBH,YACtD6D,SAOAzC,YAAW,WACGlB,SAASyB,cAAc,aAAe3B,WAAa,yBAezD8D,SAAWtD,OAAO6B,mBAAqB7B,OAAO6B,kBAAkBrC,YAEhE6D,QAAQjB,MAAMmB,QADD,SAAbD,UAAoC,QAAbA,SACC,QAEA,SAE7B"}