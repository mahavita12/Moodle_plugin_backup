{"version":3,"file":"flagbox.min.js","sources":["../src/flagbox.js"],"sourcesContent":["/**\r\n * Flag box module for local_questionflags.\r\n *\r\n * Handles injecting the reason textarea and saving reasons via AJAX.\r\n *\r\n * @module local_questionflags/flagbox\r\n * @copyright 2024 Question Flags Development Team\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery'], function($) {\r\n\r\n    /**\r\n     * Submit a reason via AJAX without page reload.\r\n     * @param {number} questionId - The question ID.\r\n     */\r\n    function submitReason(questionId) {\r\n        var reasonBox = document.getElementById('flag-reason-' + questionId);\r\n        if (!reasonBox) {\r\n            return;\r\n        }\r\n\r\n        var formData = new FormData();\r\n        formData.append('save_reason', '1');\r\n        formData.append('questionid', questionId);\r\n        formData.append('reason', reasonBox.value);\r\n        formData.append('sesskey', window.qfSesskey);\r\n\r\n        var status = document.getElementById('reason-status-' + questionId);\r\n        if (status) {\r\n            status.textContent = 'Saving...';\r\n        }\r\n\r\n        fetch(window.location.href, {\r\n            method: 'POST',\r\n            body: formData\r\n        })\r\n        .then(function(response) {\r\n            return response.json();\r\n        })\r\n        .then(function() {\r\n            if (status) {\r\n                status.textContent = 'Saved';\r\n                setTimeout(function() {\r\n                    status.textContent = '';\r\n                }, 2000);\r\n            }\r\n        })\r\n        .catch(function() {\r\n            if (status) {\r\n                status.textContent = 'Error';\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialize the flag box functionality.\r\n     * Injects textareas into flagged questions.\r\n     */\r\n    function init() {\r\n        // Expose submitReason globally for onblur handler\r\n        window.submitReason = submitReason;\r\n\r\n        var questions = document.querySelectorAll('.que');\r\n        questions.forEach(function(question) {\r\n            var flagContainer = question.querySelector('.question-flag-container');\r\n            if (!flagContainer) {\r\n                return;\r\n            }\r\n\r\n            // Get question ID from the question element\r\n            var questionId = null;\r\n            var idStr = question.id || '';\r\n            if (idStr.indexOf('question-') !== -1) {\r\n                var parts = idStr.split('-');\r\n                var slotNumber = parts[parts.length - 1];\r\n                if (window.questionMapping && window.questionMapping[slotNumber]) {\r\n                    questionId = window.questionMapping[slotNumber];\r\n                }\r\n            }\r\n\r\n            if (!questionId) {\r\n                return;\r\n            }\r\n\r\n            // Check if textarea already exists\r\n            if (document.getElementById('flag-reason-' + questionId)) {\r\n                return;\r\n            }\r\n\r\n            // Get current flag state and reason\r\n            var currentFlag = (window.questionFlagsData && window.questionFlagsData[questionId]) || '';\r\n            var reasonText = (window.questionFlagReasons && window.questionFlagReasons[questionId]) || '';\r\n            var displayStyle = (currentFlag === 'blue' || currentFlag === 'red') ? 'block' : 'none';\r\n\r\n            // Create textarea container\r\n            var reasonDiv = document.createElement('div');\r\n            reasonDiv.id = 'reason-container-' + questionId;\r\n            reasonDiv.style.cssText = 'display:' + displayStyle + '; width:100%; margin-top:5px;';\r\n\r\n            var textarea = document.createElement('textarea');\r\n            textarea.id = 'flag-reason-' + questionId;\r\n            textarea.className = 'form-control';\r\n            textarea.placeholder = 'Why did you get this wrong?';\r\n            textarea.style.cssText = 'width:100%; height:60px; font-size:12px; resize:vertical;';\r\n            textarea.value = reasonText;\r\n            textarea.onblur = function() {\r\n                submitReason(questionId);\r\n            };\r\n\r\n            var statusDiv = document.createElement('div');\r\n            statusDiv.id = 'reason-status-' + questionId;\r\n            statusDiv.style.cssText = 'font-size:10px; color:#888; text-align:right; height:15px;';\r\n\r\n            reasonDiv.appendChild(textarea);\r\n            reasonDiv.appendChild(statusDiv);\r\n            flagContainer.appendChild(reasonDiv);\r\n        });\r\n    }\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});\r\n"],"names":["define","$","submitReason","questionId","reasonBox","document","getElementById","formData","FormData","append","value","window","qfSesskey","status","textContent","fetch","location","href","method","body","then","response","json","setTimeout","catch","init","querySelectorAll","forEach","question","flagContainer","querySelector","idStr","id","indexOf","parts","split","slotNumber","length","questionMapping","currentFlag","questionFlagsData","reasonText","questionFlagReasons","displayStyle","reasonDiv","createElement","style","cssText","textarea","className","placeholder","onblur","statusDiv","appendChild"],"mappings":";;;;;;;;;AASAA,qCAAO,CAAC,WAAW,SAASC,YAMfC,aAAaC,gBACdC,UAAYC,SAASC,eAAe,eAAiBH,eACpDC,eAIDG,SAAW,IAAIC,SACnBD,SAASE,OAAO,cAAe,KAC/BF,SAASE,OAAO,aAAcN,YAC9BI,SAASE,OAAO,SAAUL,UAAUM,OACpCH,SAASE,OAAO,UAAWE,OAAOC,eAE9BC,OAASR,SAASC,eAAe,iBAAmBH,YACpDU,SACAA,OAAOC,YAAc,aAGzBC,MAAMJ,OAAOK,SAASC,KAAM,CACxBC,OAAQ,OACRC,KAAMZ,WAETa,MAAK,SAASC,iBACJA,SAASC,UAEnBF,MAAK,WACEP,SACAA,OAAOC,YAAc,QACrBS,YAAW,WACPV,OAAOC,YAAc,KACtB,SAGVU,OAAM,WACCX,SACAA,OAAOC,YAAc,mBAsE1B,CACHW,gBA5DAd,OAAOT,aAAeA,aAENG,SAASqB,iBAAiB,QAChCC,SAAQ,SAASC,cACnBC,cAAgBD,SAASE,cAAc,+BACtCD,mBAKD1B,WAAa,KACb4B,MAAQH,SAASI,IAAM,OACS,IAAhCD,MAAME,QAAQ,aAAqB,KAC/BC,MAAQH,MAAMI,MAAM,KACpBC,WAAaF,MAAMA,MAAMG,OAAS,GAClC1B,OAAO2B,iBAAmB3B,OAAO2B,gBAAgBF,cACjDjC,WAAaQ,OAAO2B,gBAAgBF,gBAIvCjC,aAKDE,SAASC,eAAe,eAAiBH,iBAKzCoC,YAAe5B,OAAO6B,mBAAqB7B,OAAO6B,kBAAkBrC,aAAgB,GACpFsC,WAAc9B,OAAO+B,qBAAuB/B,OAAO+B,oBAAoBvC,aAAgB,GACvFwC,aAAgC,SAAhBJ,aAA0C,QAAhBA,YAAyB,QAAU,OAG7EK,UAAYvC,SAASwC,cAAc,OACvCD,UAAUZ,GAAK,oBAAsB7B,WACrCyC,UAAUE,MAAMC,QAAU,WAAaJ,aAAe,oCAElDK,SAAW3C,SAASwC,cAAc,YACtCG,SAAShB,GAAK,eAAiB7B,WAC/B6C,SAASC,UAAY,eACrBD,SAASE,YAAc,8BACvBF,SAASF,MAAMC,QAAU,4DACzBC,SAAStC,MAAQ+B,WACjBO,SAASG,OAAS,WACdjD,aAAaC,iBAGbiD,UAAY/C,SAASwC,cAAc,OACvCO,UAAUpB,GAAK,iBAAmB7B,WAClCiD,UAAUN,MAAMC,QAAU,6DAE1BH,UAAUS,YAAYL,UACtBJ,UAAUS,YAAYD,WACtBvB,cAAcwB,YAAYT"}