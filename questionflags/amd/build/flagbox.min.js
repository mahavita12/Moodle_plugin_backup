/**
 * Flag box module for local_questionflags.
 *
 * Handles injecting the reason textarea and saving reasons via AJAX.
 *
 * @module local_questionflags/flagbox
 * @copyright 2024 Question Flags Development Team
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_questionflags/flagbox",["jquery"],(function($){function submitReason(questionId){var reasonBox=document.getElementById("flag-reason-"+questionId);if(reasonBox){var formData=new FormData;formData.append("save_reason","1"),formData.append("questionid",questionId),formData.append("reason",reasonBox.value),formData.append("sesskey",window.qfSesskey);var status=document.getElementById("reason-status-"+questionId);status&&(status.textContent="Saving..."),fetch(window.location.href,{method:"POST",body:formData}).then((function(response){return response.json()})).then((function(){status&&(status.textContent="Saved",setTimeout((function(){status.textContent=""}),2e3))})).catch((function(){status&&(status.textContent="Error")}))}}return{init:function(){window.submitReason=submitReason,document.querySelectorAll(".que").forEach((function(question){var contentArea=question.querySelector(".content");if(contentArea){var questionId=null,idStr=question.id||"";if(-1!==idStr.indexOf("question-")){var parts=idStr.split("-"),slotNumber=parts[parts.length-1];window.questionMapping&&window.questionMapping[slotNumber]&&(questionId=window.questionMapping[slotNumber])}if(questionId&&!document.getElementById("reason-wrapper-"+questionId)){var currentFlag=window.questionFlagsData&&window.questionFlagsData[questionId]||"",reasonText=window.questionFlagReasons&&window.questionFlagReasons[questionId]||"",isVisible="blue"===currentFlag||"red"===currentFlag,wrapperDiv=document.createElement("div");wrapperDiv.id="reason-wrapper-"+questionId,wrapperDiv.className="flag-notes-area",wrapperDiv.style.cssText="margin-top: 15px; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: "+(isVisible?"block":"none")+";";var label=document.createElement("label");label.htmlFor="flag-reason-"+questionId,label.textContent="My Notes",label.style.cssText="font-weight: bold; display: block; margin-bottom: 5px; color: #333;",wrapperDiv.appendChild(label);var textarea=document.createElement("textarea");textarea.id="flag-reason-"+questionId,textarea.className="form-control",textarea.placeholder="Add your notes here...",textarea.style.cssText="width:100%; height:80px; font-size:14px; resize:vertical; margin-bottom: 5px;",textarea.value=reasonText,textarea.onblur=function(){submitReason(questionId)},wrapperDiv.appendChild(textarea);var statusDiv=document.createElement("div");statusDiv.id="reason-status-"+questionId,statusDiv.style.cssText="font-size:11px; color:#666; text-align:right; min-height:16px;",wrapperDiv.appendChild(statusDiv);var qtext=contentArea.querySelector(".qtext");qtext&&qtext.parentNode===contentArea?qtext.nextSibling?contentArea.insertBefore(wrapperDiv,qtext.nextSibling):contentArea.appendChild(wrapperDiv):contentArea.firstChild?contentArea.insertBefore(wrapperDiv,contentArea.firstChild):contentArea.appendChild(wrapperDiv)}}})),void 0===window.originalSubmitFlag&&"function"==typeof window.submitFlag&&(window.originalSubmitFlag=window.submitFlag,window.submitFlag=function(questionId,flagColor,currentCmd){window.originalSubmitFlag(questionId,flagColor,currentCmd);var wrapper=document.getElementById("reason-wrapper-"+questionId);wrapper&&setTimeout((function(){document.querySelector("#question-"+questionId+" .flag-btn.active");var newState=window.questionFlagsData&&window.questionFlagsData[questionId];wrapper.style.display="blue"===newState||"red"===newState?"block":"none"}),500)})}}}));

//# sourceMappingURL=flagbox.min.js.map