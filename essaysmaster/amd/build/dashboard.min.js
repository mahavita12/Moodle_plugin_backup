define(['jquery', 'core/notification', 'core/templates', 'core/str'], function($, notification, templates, str) {
    'use strict';

    var Dashboard = {
        init: function() {
            this.bindEvents();
            this.refreshData();
            this.startAutoRefresh();
        },

        bindEvents: function() {
            var self = this;
            
            $(document).on('click', '.toggle-quiz-btn', function() {
                var quizId = $(this).data('quizid');
                var isEnabled = $(this).data('enabled');
                self.toggleQuiz(quizId, isEnabled);
            });

            $('#bulk-enable-btn').on('click', function() {
                self.bulkAction('enable');
            });

            $('#bulk-disable-btn').on('click', function() {
                self.bulkAction('disable');
            });

            $('#select-all-quizzes').on('change', function() {
                $('.quiz-checkbox').prop('checked', $(this).prop('checked'));
            });

            $(document).on('change', '.quiz-checkbox', function() {
                var totalCheckboxes = $('.quiz-checkbox').length;
                var checkedCheckboxes = $('.quiz-checkbox:checked').length;
                $('#select-all-quizzes').prop('checked', totalCheckboxes === checkedCheckboxes);
                if (checkedCheckboxes > 0) {
                    $('#bulk-enable-btn').prop('disabled', false);
                    $('#bulk-disable-btn').prop('disabled', false);
                } else {
                    $('#bulk-enable-btn').prop('disabled', true);
                    $('#bulk-disable-btn').prop('disabled', true);
                }
            });
        },

        toggleQuiz: function(quizId, isEnabled) {
            $.ajax({
                url: M.cfg.wwwroot + '/local/essaysmaster/ajax/toggle_quiz.php',
                type: 'POST',
                dataType: 'json',
                data: { sesskey: M.cfg.sesskey, quiz_id: quizId, enabled: isEnabled ? 1 : 0 },
                success: function(response) { if (response.success) { location.reload(); } else { notification.exception(new Error(response.error || 'Failed to toggle quiz')); } },
                error: function(xhr, status, error) { notification.exception(new Error('AJAX request failed: ' + error)); }
            });
        },

        bulkAction: function(action) {
            var selectedQuizzes = [];
            $('input[name="quiz_ids[]"]:checked').each(function() { selectedQuizzes.push($(this).val()); });
            if (selectedQuizzes.length === 0) { alert('Please select at least one quiz'); return; }
            if (!confirm('Are you sure you want to ' + action + ' ' + selectedQuizzes.length + ' quiz(zes)?')) { return; }
            var form = $('<form>', { 'method': 'POST', 'action': M.cfg.wwwroot + '/local/essaysmaster/dashboard.php?tab=quizzes' });
            form.append($('<input>', { 'type': 'hidden', 'name': 'sesskey', 'value': M.cfg.sesskey }));
            form.append($('<input>', { 'type': 'hidden', 'name': 'action', 'value': action === 'enable' ? 'bulk_enable' : 'bulk_disable' }));
            form.append($('<input>', { 'type': 'hidden', 'name': 'quizids', 'value': selectedQuizzes.join(',') }));
            form.appendTo('body').submit();
        }
    };

    return Dashboard;
});